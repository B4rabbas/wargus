#!/bin/sh

set -e

. /usr/share/debconf/confmodule

extract() {

	db_get wargus/extractdata || true
	if [ "$RET" != "true" ]; then
		db_stop || true
		return 0
	fi

	db_get wargus/cdpath || true
	if ! [ -d "$RET" ]; then
		db_stop || true
		echo "${RET} doesn't exist - can't extract Warcraft II data" >&2
		return 1
	fi

	CDPATH="$RET"

	db_get wargus/extractdataexp || true
	if [ "$RET" = "true" ]; then
	    db_get wargus/expcdpath || true
	    if ! [ -d "$RET" ]; then
		db_stop || true
		echo "${RET} doesn't exist - can't extract Warcraft II expansion data" >&2
		return 1
	    fi
	    CDPATHEXP="$RET"
	fi

	ARGS=

	db_get wargus/extractvideo || true
	if [ "$RET" = "true" ]; then
		ARGS="$ARGS -v"
	fi

	db_get wargus/ripcd || true
	if [ "$RET" = "true" ]; then
		ARGS="$ARGS -r"
	fi

	db_stop || true
        echo $ARGS
        echo "$CDPATH"
	wartool $ARGS "$CDPATH" /usr/share/games/stratagus/wargus || return $?
	if ! [ -z "$CDPATHEXP" ]; then
            echo "$CDPATHEXP"
	    wartool $ARGS "$CDPATHEXP" /usr/share/games/stratagus/wargus || return $?
	fi
	if [ $(dpkg-query -W -f='${Status}' musescore-soundfont-gm 2>/dev/null | grep -c "ok installed") -eq 1 ]; then
		cp /usr/share/sounds/sf2/TimGM6mb.sf2 /usr/share/games/stratagus/wargus/music
	fi
	db_stop || true

	return $?
}

if [ "$1" = "configure" ]; then
	extract || exit $?
fi

#DEBHELPER#

exit 0
